<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<title>Pantalla Waikiki</title>
<style>
body, html {margin:0; padding:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background-color:black; overflow:hidden;}
#media {max-width:100%; max-height:100%; display:none;}
#video {max-width:100%; max-height:100%; display:none;}
#textDisplay {position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:3em; color:white; text-align:center; z-index:1000; pointer-events:none; padding:10px 20px; border-radius:10px; background-color:transparent;}
</style>
</head>
<body>
<img id="media">
<video id="video" autoplay loop muted></video>
<div id="textDisplay"></div>

<script>
const img = document.getElementById("media");
const vid = document.getElementById("video");
const textDiv = document.getElementById("textDisplay");

let modeInterval = null;

function stopMode() {
    if(modeInterval) clearInterval(modeInterval);
    modeInterval = null;
    document.body.style.backgroundImage = "";
    document.body.style.backgroundColor = "black";
}

// Mostra el text sempre que hi hagi contingut
function aplicarText(text) {
    textDiv.innerText = text && text.trim() !== "" ? text : "";
}

// Aplica l’estat rebut
function aplicarEstat(state) {
    stopMode();
    aplicarText(state.text);

    switch(state.mode) {
        case "color":
            document.body.style.backgroundColor = state.color || "black";
            img.style.display = "none";
            vid.style.display = "none";
            break;

        case "imatge":
            if(state.media) {
                img.src = state.media;
                img.style.display = "block";
                vid.style.display = "none";
            }
            document.body.style.backgroundColor = "black";
            break;

        case "video":
            if (state.media) {
                vid.src = state.media;
                vid.style.display = "block";
                img.style.display = "none";
                vid.load();
                vid.play().catch(e => console.log("Autoplay bloquejat:", e));
            }
            document.body.style.backgroundColor = "black";
            break;

        case "mode_logo":
            img.src = "https://github.com/gsolerf/Waikiki/raw/main/media/logo.jpeg"; // enllaç públic
            img.style.display = "block";
            vid.style.display = "none";
            document.body.style.backgroundColor = "black";
            break;

        case "mode_visual":
            if (state.media) {
                // state.media ha de ser l'enllaç complet de YouTube (ex: https://www.youtube.com/watch?v=VIDEO_ID)
                // Extraiem l'ID del vídeo
                const videoIdMatch = state.media.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                if(videoIdMatch && videoIdMatch[1]){
                    const videoId = videoIdMatch[1];
            
                    // Creem o reutilitzem un div per l'iframe
                    let container = document.getElementById("youtubeContainer");
                    if(!container){
                        container = document.createElement("div");
                        container.id = "youtubeContainer";
                        container.style.position = "absolute";
                        container.style.top = 0;
                        container.style.left = 0;
                        container.style.width = "100%";
                        container.style.height = "100%";
                        container.style.zIndex = 0;
                        document.body.appendChild(container);
                    }
            
                container.innerHTML = `<iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&loop=1&mute=1&playlist=${videoId}" 
                    width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
                </iframe>`;
            
                textDiv.innerText = "";
                img.style.display = "none";
                vid.style.display = "none";
            }
        }
        document.body.style.backgroundColor = "black";
        break;


        case "mode1":
            modeInterval = setInterval(()=>{const c=["#FF1493","#1E90FF","#FFD700"]; document.body.style.backgroundColor = c[Math.floor(Math.random()*c.length)];},300);
            img.style.display = "none"; vid.style.display = "none";
            break;

        case "mode2":
            modeInterval = setInterval(()=>{document.body.style.backgroundColor = Math.random()<0.5?"#FFFFFF":"#000000";},50);
            img.style.display = "none"; vid.style.display = "none";
            break;

        case "mode3":
            modeInterval = setInterval(()=>{const c=["#FFB6C1","#ADD8E6","#FFFF99"]; document.body.style.backgroundColor = c[Math.floor(Math.random()*c.length)];},800);
            img.style.display = "none"; vid.style.display = "none";
            break;

        case "mode4":
            modeInterval = setInterval(()=>{const c=["#FF1493","#1E90FF","#FFD700","#FF4500","#32CD32","#9400D3"]; document.body.style.backgroundColor = c[Math.floor(Math.random()*c.length)];},150);
            img.style.display = "none"; vid.style.display = "none";
            break;

        case "mode5":
            modeInterval = setInterval(()=>{
                const c=["#FF1493","#1E90FF","#FFD700"];
                const c1=c[Math.floor(Math.random()*c.length)];
                const c2=c[Math.floor(Math.random()*c.length)];
                document.body.style.backgroundImage=`linear-gradient(to right, ${c1}, ${c2})`;
            },500);
            img.style.display = "none"; vid.style.display = "none";
            break;

        default:
            console.warn("Mode desconegut:", state.mode);
    }
}

// WebSocket
const ws = new WebSocket("wss://waikiki.onrender.com/ws");
ws.onopen = ()=>console.log("Pantalla connectada");
ws.onclose = ()=>console.log("Pantalla desconnectada");
ws.onerror = (e)=>console.error("Error WS:",e);

ws.onmessage = (event)=>{
    try {
        const state = JSON.parse(event.data);
        aplicarEstat(state);
    } catch(e) { console.error("Error processant missatge WS:",e); }
};
</script>
</body>
</html>
